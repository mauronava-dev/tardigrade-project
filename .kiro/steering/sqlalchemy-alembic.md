# SQLAlchemy & Alembic Guidelines

## Supported Engines

- Aurora PostgreSQL: `postgresql+asyncpg://`
- Aurora MySQL: `mysql+aiomysql://`
- Redshift: `redshift+redshift_connector://` (limited ORM support)

## Alembic Commands

```bash
# Generate migration from model changes
alembic revision --autogenerate -m "description"

# Apply migrations
alembic upgrade head

# Rollback one migration
alembic downgrade -1

# Show current version
alembic current

# Preview SQL without applying
alembic upgrade head --sql
```

## Migration Best Practices

1. Always review autogenerated migrations before applying
2. Include both `upgrade()` and `downgrade()` functions
3. Test migrations in QA before production
4. Backup database before applying destructive migrations
5. Separate data migrations from schema migrations

## Model Example

```python
from sqlalchemy import Column, Integer, String, DateTime
from sqlalchemy.sql import func
from infrastructure.database.base import Base


class User(Base):
    """User database model."""

    __tablename__ = "users"

    id = Column(Integer, primary_key=True)
    email = Column(String(120), unique=True, nullable=False, index=True)
    created_at = Column(DateTime, server_default=func.now())
```

## Async Session Pattern

```python
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker
import os

engine = create_async_engine(os.getenv("DATABASE_URL", ""))
async_session = sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)
```
